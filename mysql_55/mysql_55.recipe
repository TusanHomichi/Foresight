class Mysql(CPackageRecipe):
    name = 'mysql_55'
    version = '5.5.19'
    upstreamName = 'mysql'

    buildRequires = [ 
        'gperf:runtime', 'perl:runtime', 'cmake:runtime', 'readline:devel',
        'ncurses:devel', 'zlib:devel', 'libtool:runtime', 'time:runtime',
        'gcc:devel', 'gcc-c++:runtime', 'libstdc++:devel', 'openssl:devel',
        'bison:runtime', 'net-tools:runtime', 'util-linux:runtime', 'perl:lib',
        'procps:runtime', 'install-info:runtime', 'bash:runtime', 'libtermcap:devel',
        'autoconf:runtime',  'automake:runtime', 'm4:runtime'
    ]

    def setup(r):
        # this is for downloading the "enterprise" version
        #r.addArchive('ftp://ftp.mysql.com/pub/%(name)s/src/')
        # download location for the "community" version
        r.macros.majorversion = r.version[:r.version.rindex('.')]
        r.macros.name = r.upstreamName
        r.addArchive('http://downloads.mysql.com/archives/%(name)s-%(majorversion)s/')
        r.addSource('my.cnf', dest='%(sysconfdir)s/', mode=0644)
        r.addSource('mysql.init', dest='%(initdir)s/mysql', mode=0755, macros=True)
        r.addSource('mysql.logrotate', dest='%(sysconfdir)s/logrotate.d/', mode=0644)

        r.macros.cflags += ' -O2 -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE -fwrapv'
        r.macros.cxxflags += ' -fno-rtti -fno-exceptions -felide-constructors'
        r.macros.mysqldir = '%(servicedir)s/mysql'

        r.CMake(
            ' -DMANUFACTURER:STRING="Foresight Linux"'
            ' -DWITH_ARCHIVE_STORAGE_ENGINE:BOOL=ON'
            ' -DWITH_BLACKHOLE_STORAGE_ENGINE:BOOL=ON'
            ' -DWITH_FEDERATED_STORAGE_ENGINE:BOOL=ON'
            ' -DWITH_INNOBASE_STORAGE_ENGINE:BOOL=ON'
            ' -DWITH_PARTITION_STORAGE_ENGINE:BOOL=ON'
            ' -DWITH_PERFSCHEMA_STORAGE_ENGINE:BOOL=ON'
            ' -DWITH_PIC:BOOL=ON'
            ' -DWITH_READLINE:BOOL=ON'
            ' -DWITH_SSL:STRING=system'
            ' -DINSTALL_LIBDIR="%(libdir)s"'
        )
        # mysql forces a lib/mysql path in mysql config and that is wrong on 64bit
        r.Replace('^fix_path pkglibdir \$pkglibdir_rel lib/mysql lib$', '', 'scripts/mysql_config.sh')
        r.Make()

        #r.TestSuite('.', 'make check')
        # make check uses mysqladmin to manage the daemon during testing
        #r.TestSuiteLinks(fileMap={'client/mysqladmin': '/usr/bin/mysqladmin'})
        #r.TestSuite('.', 'make test')

        r.MakeInstall()
        # Temporary fix until someone at Oracle fixes libmysqlservices.so, then
        # the next three lines can be axed. 
        r.Run('ls -l %(libdir)s/*')
        r.Move('%(libdir)s/libmysqlservices.so', '%(libdir)s/libmysqlservices.so.18.0.0')
        r.Symlink('%(libdir)s/libmysqlservices.so.18.0.0', '%(libdir)s/libmysqlservices.so.18')
        r.Symlink('%(libdir)s/libmysqlservices.so.18.0.0', '%(libdir)s/libmysqlservices.so')

        r.Move('%(prefix)s/scripts/mysql_install_db', '%(bindir)s/')
        r.Install('include/my_config.h', '%(includedir)s/mysql/')

        r.MakeDirs('%(localstatedir)s/run/mysqld',
                   '%(mysqldir)s')

        r.Move('%(prefix)s/sql-bench', '%(datadir)s/')

        r.Ownership('mysql', 'mysql', '%(localstatedir)s/run/mysqld')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/run/mysqld')

        r.Create('%(localstatedir)s/log/mysqld.log', mode=0640)
        r.Ownership('mysql', 'mysql', '%(localstatedir)s/log/mysqld.log')

        r.Ownership('mysql', 'mysql', '%(mysqldir)s')
        r.ExcludeDirectories(exceptions='%(mysqldir)s')

        r.Remove('%(datadir)s/mysql/mysql-*.spec',
                 '%(datadir)s/mysql/mysql-log-rotate')
        r.Remove('%(prefix)s/mysql-test/', recursive=True)
        r.Remove('%(datadir)s/mysql/binary-configure',
                 '%(datadir)s/mysql/mi_test_all*',
                 '%(datadir)s/mysql/*.cnf',
                 '%(datadir)s/mysql/mysql.server')
        # runtime stuff with bad rpaths generated by "make test"
        r.Run("/bin/chmod og-w -Rf %(builddir)s/tests")

        r.Doc('COPYING*', 'support-files/*.cnf')

        r.Config(exceptions='%(initdir)s/.*')
        r.SharedLibrary(subtrees='%(libdir)s/mysql/')

        r.ComponentSpec("test",
                        "%(bindir)s/mysql_client_test")
        r.ComponentSpec("devel",
                        "%(bindir)s/comp_err",
                        "%(bindir)s/msql2mysql",
                        "%(bindir)s/mysql_config")

        r.PackageSpec('%s-server' % r.name,
                      'support-files/*.cnf',
                      '%(bindir)s/safe_mysqld',
                      '%(mandir)s.*/safe_mysqld.*',
                      '%(bindir)s/mysqladmin',
                      '%(mandir)s.*/mysqladmin.*',
                      '%(bindir)s/mysqld_.*',
                      '%(mandir)s.*/mysqld\..*',
                      '%(mandir)s.*/mysqld_.*',
                      '%(mandir)s.*/mysql.server.*',
                      '%(bindir)s/innochecksum',
                      '%(bindir)s/isam.*',
                      '%(bindir)s/myisam.*',
                      '%(mandir)s.*/myisam.*'
                      '%(bindir)s/my_print_defaults',
                      '%(bindir)s/mysql_convert_table_format',
                      '%(bindir)s/mysql_create_system_tables',
                      '%(bindir)s/mysql_explain_log',
                      '%(bindir)s/mysql_find_rows',
                      '%(bindir)s/mysql_fix_extensions',
                      '%(bindir)s/mysql_fix_privilege_tables',
                      '%(mandir)s.*/mysql_fix_privilege_tables.*',
                      '%(bindir)s/mysql_install_db',
                      '%(bindir)s/mysql_secure_installation',
                      '%(bindir)s/mysql_setpermission',
                      '%(bindir)s/mysql_tableinfo',
                      '%(bindir)s/mysql_tzinfo_to_sql',
                      '%(bindir)s/mysql_waitpid',
                      '%(bindir)s/mysql_zap',
                      '%(mandir)s.*/mysql_zap.*',
                      '%(bindir)s/mysqlbinlog',
                      '%(mandir)s.*/mysqlbinlog',
                      '%(bindir)s/mysqlcheck',
                      '%(mandir)s.*/mysqlcheck.*',
                      '%(bindir)s/mysqlhotcopy',
                      '%(mandir)s.*/mysqlhotcopy.*',
                      '%(bindir)s/mysqltest.*',
                      '%(bindir)s/perror',
                      '%(mandir)s.*/perror.*',
                      '%(bindir)s/replace',
                      '%(mandir)s.*/replace.*',
                      '%(bindir)s/resolve_stack_dump',
                      '%(bindir)s/resolveip',
                      '%(bindir)s/pack_isam',
                      '%(bindir)s/mysqlmanager.*',
                      '%(sbindir)s/.*',
                      '%(initdir)s/mysqld',
                      '%(mysqldir)s',
                      '%(localstatedir)s/run/mysqld',
                      '%(localstatedir)s/log/mysqld.log',
                      )
        r.Requires('%s:runtime' % r.name, '%(sbindir)s/.*')

        r.PackageSpec('%s-bench' % r.name,
                      '%(datadir)s/sql-bench/.*')


#
# Copyright (c) 2004-2008 rPath, Inc.
# This file is distributed under the terms of the MIT License.
# A copy is available at http://www.rpath.com/permanent/mit-license.html
#

class Mysql(CPackageRecipe):
    name = 'mysql'
    version = '5.0.88'

    buildRequires = [ 'gperf:runtime', 'perl:runtime', 'readline:devel',
        'ncurses:devel', 'zlib:devel', 'libtool:runtime', 'time:runtime',
        'gcc:devel', 'gcc-c++:runtime', 'libstdc++:devel', 'openssl:devel',
        'bison:runtime', 'net-tools:runtime', 'util-linux:runtime', 'perl:lib',
        'procps:runtime', 'install-info:runtime', 'bash:runtime', 'krb5:devel',]

    def setup(r):
        # this is for downloading the "enterprise" version
        #r.addArchive('ftp://ftp.mysql.com/pub/%(name)s/src/')
        # download location for the "community" version
        r.addArchive('ftp://mirror.services.wisc.edu/mirrors/mysql/Downloads/MySQL-%(major_version)s/')
        r.addSource('mysql.init', macros=True,
                    dest='%(initdir)s/mysqld', mode=0755)
        r.addSource('mysql.logrotate', macros=True,
                    dest='%(sysconfdir)s/logrotate.d/mysqld', mode=0644)
        r.addSource('my.cnf', macros=True,
                    dest='%(sysconfdir)s/my.cnf', mode=0644)

        # RPL-2188. this fixes a bug where mysql cannot create a database in
        # traditional mode.  Fixed in 5.0.67 and later.
        # r.addPatch('mysql-5.0.51-traditional.patch')

        r.macros.cflags += ' -O2 -D_GNU_SOURCE -D_FILE_OFFSET_BITS=64 -D_LARGEFILE_SOURCE -fwrapv'
        r.macros.cxxflags += ' -fno-rtti -fno-exceptions -felide-constructors'
        r.macros.mysqldir = '%(servicedir)s/mysql'

        r.Configure(
            '--enable-assembler '
            '--with-extra-charsets=all '
            '--localstatedir=%(mysqldir)s '
            '--libexecdir=%(sbindir)s '
            '--with-mysqld-user="mysql" '
            '--with-unix-socket-path=%(mysqldir)s/mysql.sock '

            '--with-berkeley-db '
            '--with-archive-storage-engine '
            '--with-innodb '
            '--with-federated-storage-engine '
            '--with-query-cache '
            '--with-big-tables '
            '--without-embedded-server '

            '--with-readline '
            '--with-openssl '
            '--enable-local-infile '
            '--enable-shared '
            '--enable-largefile '
            '--enable-thread-safe-client '
            '--with-gnu-ld '

            '--without-debug '
            '--with-bench '
            )

        # mysql forces a lib/mysql path in mysql config and that is wrong on 64bit
        r.Replace('^fix_path pkglibdir \$pkglibdir_rel lib/mysql lib$', '', 'scripts/mysql_config.sh')
        r.Make()

        #r.TestSuite('.', 'make check')
        # make check uses mysqladmin to manage the daemon during testing
        #r.TestSuiteLinks(fileMap={'client/mysqladmin': '/usr/bin/mysqladmin'})
        #r.TestSuite('.', 'make test')

        r.MakeInstall()
        r.Install('include/my_config.h', '%(includedir)s/mysql/')

        r.MakeDirs('%(localstatedir)s/run/mysqld',
                   '%(mysqldir)s')

        r.Move('%(prefix)s/sql-bench', '%(datadir)s/')

        r.Ownership('mysql', 'mysql', '%(localstatedir)s/run/mysqld')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/run/mysqld')

        r.Create('%(localstatedir)s/log/mysqld.log', mode=0640)
        r.Ownership('mysql', 'mysql', '%(localstatedir)s/log/mysqld.log')
        r.ExcludeDirectories(exceptions='%(localstatedir)s/log/mysqld.log')

        r.Ownership('mysql', 'mysql', '%(mysqldir)s')
        r.ExcludeDirectories(exceptions='%(mysqldir)s')

        r.Remove('%(datadir)s/mysql/mysql-*.spec',
                 '%(datadir)s/mysql/mysql-log-rotate')
        r.Remove('%(prefix)s/mysql-test/', recursive=True)
        r.Remove('%(datadir)s/mysql/binary-configure',
                 '%(datadir)s/mysql/mi_test_all*',
                 '%(datadir)s/mysql/*.cnf',
                 '%(datadir)s/mysql/mysql.server')
        # runtime stuff with bad rpaths generated by "make test"
        r.Run("/bin/chmod og-w -Rf %(builddir)s/tests")

        r.Doc('COPYING*', 'support-files/*.cnf')

        r.SharedLibrary(subtrees='%(libdir)s/mysql/')

        r.ComponentSpec("test",
                        "%(bindir)s/mysql_client_test")
        r.ComponentSpec("devel",
                        "%(bindir)s/comp_err",
                        "%(bindir)s/msql2mysql",
                        "%(bindir)s/mysql_config")

        r.PackageSpec('mysql-server',
                      '%(sysconfdir)s/my.cnf',
                      'support-files/*.cnf',
                      '%(bindir)s/safe_mysqld',
                      '%(mandir)s.*/safe_mysqld.*',
                      '%(bindir)s/mysqladmin',
                      '%(mandir)s.*/mysqladmin.*',
                      '%(bindir)s/mysqld_.*',
                      '%(mandir)s.*/mysqld\..*',
                      '%(mandir)s.*/mysqld_.*',
                      '%(mandir)s.*/mysql.server.*',
                      '%(bindir)s/innochecksum',
                      '%(bindir)s/isam.*',
                      '%(bindir)s/myisam.*',
                      '%(mandir)s.*/myisam.*'
                      '%(bindir)s/my_print_defaults',
                      '%(bindir)s/mysql_convert_table_format',
                      '%(bindir)s/mysql_create_system_tables',
                      '%(bindir)s/mysql_explain_log',
                      '%(bindir)s/mysql_find_rows',
                      '%(bindir)s/mysql_fix_extensions',
                      '%(bindir)s/mysql_fix_privilege_tables',
                      '%(mandir)s.*/mysql_fix_privilege_tables.*',
                      '%(bindir)s/mysql_install_db',
                      '%(bindir)s/mysql_secure_installation',
                      '%(bindir)s/mysql_setpermission',
                      '%(bindir)s/mysql_tableinfo',
                      '%(bindir)s/mysql_tzinfo_to_sql',
                      '%(bindir)s/mysql_waitpid',
                      '%(bindir)s/mysql_zap',
                      '%(mandir)s.*/mysql_zap.*',
                      '%(bindir)s/mysqlbinlog',
                      '%(mandir)s.*/mysqlbinlog',
                      '%(bindir)s/mysqlcheck',
                      '%(mandir)s.*/mysqlcheck.*',
                      '%(bindir)s/mysqlhotcopy',
                      '%(mandir)s.*/mysqlhotcopy.*',
                      '%(bindir)s/mysqltest.*',
                      '%(bindir)s/perror',
                      '%(mandir)s.*/perror.*',
                      '%(bindir)s/replace',
                      '%(mandir)s.*/replace.*',
                      '%(bindir)s/resolve_stack_dump',
                      '%(bindir)s/resolveip',
                      '%(bindir)s/pack_isam',
                      '%(bindir)s/mysqlmanager.*',
                      '%(sbindir)s/.*',
                      '%(initdir)s/mysqld',
                      '%(mysqldir)s',
                      '%(sysconfdir)s/logrotate.d/mysqld',
                      '%(localstatedir)s/run/mysqld',
                      '%(localstatedir)s/log/mysqld.log',
                      )
        r.Requires('mysql:runtime', '%(sbindir)s/.*')
        r.TagSpec('initscript', '%(initdir)s/')

        r.PackageSpec('mysql-bench',
                      '%(datadir)s/sql-bench/.*')
